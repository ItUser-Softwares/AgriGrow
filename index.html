<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pakistan Agriculture Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<style>
  #map { height: 100vh; }
  .leaflet-popup-content-wrapper { max-width: 400px; max-height: 80vh; overflow-y: auto; }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-600 to-purple-700">

<!-- Header -->
<div class="absolute top-5 left-1/2 transform -translate-x-1/2 text-center text-white z-50">
  <h1 class="text-3xl font-bold mb-2">ğŸŒ¾ Pakistan Agriculture Intelligence</h1>
  <p class="text-lg">Click on map or search to get crop recommendations</p>
</div>

<!-- Search -->
<div class="absolute top-28 left-1/2 transform -translate-x-1/2 z-50 flex gap-2">
  <input id="searchInput" type="text" placeholder="Search city or coordinates (lat, lon)" 
         class="rounded-full px-4 py-2 w-80 text-gray-800 focus:outline-none">
  <button id="searchBtn" class="bg-white text-gray-800 px-4 py-2 rounded-full hover:bg-gray-200">ğŸ” Search</button>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Coordinates display -->
<div id="coordinatesDisplay" class="absolute bottom-5 left-5 bg-black bg-opacity-70 text-white px-4 py-2 rounded z-50 font-mono">
  Lat: --, Lon: --
</div>

<script>
const map = L.map('map').setView([30.3753, 69.3451], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors',
  maxZoom: 18
}).addTo(map);

// Demo city list
const majorCities = [
  { name: "Karachi", lat: 24.8607, lon: 67.0011, province: "Sindh" },
  { name: "Lahore", lat: 31.5804, lon: 74.3587, province: "Punjab" },
  { name: "Islamabad", lat: 33.6844, lon: 73.0479, province: "Punjab" },
  { name: "Quetta", lat: 30.1798, lon: 66.9750, province: "Balochistan" }
];

// Update coordinates display
map.on('mousemove', e => {
  $('#coordinatesDisplay').text(`Lat: ${e.latlng.lat.toFixed(4)}, Lon: ${e.latlng.lng.toFixed(4)}`);
});

// Click map to fetch data
map.on('click', async function(e){
  const lat = e.latlng.lat;
  const lon = e.latlng.lng;

  const loadingPopup = L.popup({ closeOnClick: false, autoClose: false })
    .setLatLng(e.latlng)
    .setContent('<div class="text-center p-4">Loading...</div>')
    .openOn(map);

  try {
    const data = await $.ajax({
      url: `http://localhost:8000/api/v1/analysis/${lat}/${lon}`,
      method: 'GET',
      dataType: 'json'
    });
    loadingPopup.setContent(createPopupContent(data));
  } catch(err) {
    console.error(err);
    loadingPopup.setContent(createPopupContent(createDemoData(lat, lon)));
  }
});

// Search
$('#searchBtn').click(searchLocation);
$('#searchInput').keypress(function(e){
  if(e.key === 'Enter') searchLocation();
});

function searchLocation() {
  const query = $('#searchInput').val().trim();
  if(!query) return;

  const coordMatch = query.match(/(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/);
  if(coordMatch){
    const lat = parseFloat(coordMatch[1]);
    const lon = parseFloat(coordMatch[2]);
    map.setView([lat, lon], 12);
    L.marker([lat, lon]).addTo(map)
      .bindPopup(`Coordinates: ${lat.toFixed(4)}, ${lon.toFixed(4)}`).openPopup();
  } else {
    const city = majorCities.find(c => c.name.toLowerCase() === query.toLowerCase());
    if(city){
      map.setView([city.lat, city.lon], 12);
      L.marker([city.lat, city.lon]).addTo(map)
        .bindPopup(`${city.name}, ${city.province}`).openPopup();
    } else alert('City not found!');
  }
  $('#searchInput').val('');
}

// Create popup content
function createPopupContent(data){
  const w = data.weather, s = data.soil, r = data.crop_recommendations, l = data.location;
  let cropsHtml = '';
  if(r && r.length>0){
    cropsHtml = r.map(c => `
      <div class="bg-pink-500 text-white p-2 rounded mb-2">
        <h5 class="font-bold">ğŸŒ¾ ${c.crop_name}</h5>
        <div>Suitability: ${c.suitability_score}/10</div>
        <div style="font-size:0.85rem;">
          ğŸ’§ ${c.irrigation_need}mm, ğŸ§ª ${c.fertilizer_npk}, ğŸ“… ${c.season}
        </div>
      </div>
    `).join('');
  } else {
    cropsHtml = '<div>No suitable crops found</div>';
  }

  return `
    <div class="p-4 max-h-80 overflow-y-auto">
      <h4 class="text-center font-bold mb-2">ğŸ‡µğŸ‡° Agricultural Analysis</h4>
      <div class="mb-2">
        <strong>Region:</strong> ${l.region || 'Pakistan'}<br>
        <strong>Coordinates:</strong> ${l.latitude.toFixed(4)}, ${l.longitude.toFixed(4)}
      </div>
      <div class="mb-2">
        <strong>ğŸŒ¤ï¸ Weather:</strong> Temp: ${w.temperature}Â°C, Humidity: ${w.humidity}%, Rainfall: ${w.rainfall}mm, Wind: ${w.wind_speed} km/h
      </div>
      <div class="mb-2">
        <strong>ğŸŒ± Soil:</strong> pH: ${s.ph}, Type: ${s.soil_type}, N: ${s.nitrogen}%, P: ${s.phosphorus}ppm, K: ${s.potassium}ppm
      </div>
      <div><strong>ğŸŒ¾ Crop Recommendations:</strong>${cropsHtml}</div>
    </div>
  `;
}

// Demo data
function createDemoData(lat, lon){
  return {
    location: { latitude: lat, longitude: lon, region: 'Demo Region' },
    weather: { temperature: 25 + Math.random()*10, humidity: 50, rainfall: 5, wind_speed: 10 },
    soil: { ph:6.5, soil_type:'Alluvial', nitrogen:0.03, phosphorus:12, potassium:120 },
    crop_recommendations: [
      { crop_name:'Wheat', suitability_score:8, irrigation_need:450, fertilizer_npk:'120-60-60', season:'Rabi' },
      { crop_name:'Rice', suitability_score:7, irrigation_need:1200, fertilizer_npk:'120-90-60', season:'Kharif' }
    ]
  };
}
</script>
</body>
</html>